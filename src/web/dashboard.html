<!DOCTYPE html>
<html lang="ko">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<title>Order Log Mini Dashboard</title>
		<style>
			:root {
				--bg: #0b1020;
				--card: #111a33;
				--muted: #93a4c7;
				--text: #e7eeff;
				--line: #22305a;
			}
			* {
				box-sizing: border-box;
			}
			body {
				margin: 0;
				font-family: ui-sans-serif, system-ui, -apple-system,
					"Apple SD Gothic Neo", "Noto Sans KR", Segoe UI, Roboto,
					Arial;
				background: radial-gradient(
					1200px 700px at 20% 10%,
					#182454 0%,
					var(--bg) 55%
				);
				color: var(--text);
			}
			header {
				padding: 20px 18px 10px;
				max-width: 1100px;
				margin: 0 auto;
			}
			h1 {
				margin: 0;
				font-size: 18px;
				letter-spacing: 0.2px;
			}
			p {
				margin: 8px 0 0;
				color: var(--muted);
				font-size: 13px;
				line-height: 1.45;
			}

			.wrap {
				max-width: 1100px;
				margin: 0 auto;
				padding: 12px 18px 40px;
			}

			.row {
				display: grid;
				grid-template-columns: 1fr;
				gap: 12px;
			}
			@media (min-width: 960px) {
				.row {
					grid-template-columns: 1.1fr 0.9fr;
				}
			}

			.card {
				background: linear-gradient(
					180deg,
					rgba(255, 255, 255, 0.03),
					rgba(255, 255, 255, 0.015)
				);
				border: 1px solid rgba(255, 255, 255, 0.06);
				border-radius: 16px;
				box-shadow: 0 10px 24px rgba(0, 0, 0, 0.18);
				padding: 14px;
			}
			.card h2 {
				margin: 0 0 10px;
				font-size: 14px;
				color: #cfe0ff;
			}
			.muted {
				color: var(--muted);
				font-size: 12px;
			}

			.controls {
				display: flex;
				flex-wrap: wrap;
				gap: 10px;
				align-items: center;
			}
			.btn,
			select,
			input[type="file"] {
				background: rgba(255, 255, 255, 0.04);
				border: 1px solid rgba(255, 255, 255, 0.1);
				color: var(--text);
				border-radius: 12px;
				padding: 9px 10px;
				font-size: 12px;
			}
			.btn {
				cursor: pointer;
			}
			.btn:hover {
				background: rgba(255, 255, 255, 0.06);
			}
			select {
				cursor: pointer;
			}
			.pill {
				display: inline-flex;
				align-items: center;
				gap: 8px;
				padding: 7px 10px;
				border-radius: 999px;
				background: rgba(255, 255, 255, 0.04);
				border: 1px solid rgba(255, 255, 255, 0.08);
				font-size: 12px;
				color: var(--muted);
			}

			.kpis {
				display: grid;
				grid-template-columns: repeat(2, 1fr);
				gap: 10px;
			}
			@media (min-width: 700px) {
				.kpis {
					grid-template-columns: repeat(4, 1fr);
				}
			}
			.kpi {
				padding: 12px;
				border-radius: 14px;
				background: rgba(255, 255, 255, 0.03);
				border: 1px solid rgba(255, 255, 255, 0.06);
			}
			.kpi .label {
				font-size: 11px;
				color: var(--muted);
			}
			.kpi .value {
				margin-top: 6px;
				font-size: 16px;
				font-weight: 700;
				color: var(--text);
			}
			.kpi .hint {
				margin-top: 6px;
				font-size: 11px;
				color: var(--muted);
			}

			canvas {
				width: 100%;
				height: 240px;
				background: rgba(0, 0, 0, 0.12);
				border: 1px solid rgba(255, 255, 255, 0.06);
				border-radius: 14px;
			}
			.chartFooter {
				display: flex;
				justify-content: space-between;
				margin-top: 8px;
				color: var(--muted);
				font-size: 11px;
			}

			table {
				width: 100%;
				border-collapse: collapse;
				overflow: hidden;
				border-radius: 14px;
				border: 1px solid rgba(255, 255, 255, 0.06);
			}
			th,
			td {
				padding: 10px 10px;
				font-size: 12px;
				border-bottom: 1px solid rgba(255, 255, 255, 0.06);
			}
			th {
				text-align: left;
				color: #cfe0ff;
				background: rgba(255, 255, 255, 0.03);
			}
			td {
				color: var(--text);
			}
			tr:last-child td {
				border-bottom: none;
			}
			.right {
				text-align: right;
			}

			.note {
				margin-top: 10px;
				font-size: 11px;
				color: var(--muted);
				line-height: 1.45;
			}
			.warn {
				color: #ffcc88;
			}
			.ok {
				color: #9fe7b2;
			}
		</style>
	</head>

	<body>
		<header>
			<h1>배달 주문 로그 미니 대시보드</h1>
			<p>
				<span class="pill"
					>입력:
					<strong style="color: #e7eeff">kpi.json</strong> (파이프라인
					결과)</span
				>
				<span class="pill"
					>표시: KPI · 그룹별 KPI · 병목 · 데이터 품질</span
				>
			</p>
		</header>

		<div class="wrap">
			<div class="card">
				<div class="controls">
					<input
						id="file"
						type="file"
						accept="application/json,.json"
					/>
					<button class="btn" id="loadSample">
						샘플 데이터로 보기
					</button>
					<span class="pill"
						>Group Key:
						<select id="groupKey">
							<option value="region">region</option>
							<option value="store_id">store_id</option>
							<option value="hour_bucket">hour_bucket</option>
						</select>
					</span>
					<span class="pill"
						>Top N:
						<select id="topN">
							<option>3</option>
							<option>5</option>
							<option>10</option>
						</select>
					</span>
					<span class="pill"
						>상태:
						<span id="statusText">JSON 업로드 대기</span></span
					>
				</div>
				<div class="note">
					GitHub Pages 환경에서는 같은 경로의 `kpi.json`을 자동 로드해.
					자동 로드가 실패하면 파일 선택 버튼으로 `output/kpi.json`을
					직접 업로드해도 돼.
				</div>
			</div>

			<div style="height: 12px"></div>

			<div class="row">
				<div class="card">
					<h2>요약 KPI</h2>
					<div class="kpis" id="kpiCards"></div>
					<div class="note" id="kpiNote"></div>
				</div>

				<div class="card">
					<h2>데이터 품질 (Data Quality)</h2>
					<div class="kpis" id="dqCards"></div>
					<div class="note">
						품질 지표는 “분석 결과를 믿을 수 있는지”를 보여줘.
						누락/중복/역순율이 높으면 KPI 해석이 흔들릴 수 있어.
					</div>
				</div>
			</div>

			<div style="height: 12px"></div>

			<div class="row">
				<div class="card">
					<h2>그룹별 평균 리드타임 (Average Lead Time)</h2>
					<canvas id="chartByGroup"></canvas>
					<div class="chartFooter">
						<span id="byGroupCaption">-</span>
						<span class="muted">단위: 초</span>
					</div>
					<div class="note">
						Group Key를 바꾸면 `byGroup` 기반으로 다시 그려져.
					</div>
				</div>

				<div class="card">
					<h2>병목 구간 Top</h2>
					<canvas id="chartBottleneck"></canvas>
					<div class="chartFooter">
						<span id="bottleneckCaption">-</span>
						<span class="muted">비율: 0~1</span>
					</div>
					<div class="note">
						병목은 주문별로 가장 오래 걸린 구간(S1~S6)을 집계한
						결과야.
					</div>
				</div>
			</div>

			<div style="height: 12px"></div>

			<div class="card">
				<h2>그룹별 상세 테이블</h2>
				<div class="muted" style="margin-bottom: 8px">
					completedOrders / averageLeadTime / delayedOrderRate
				</div>
				<div style="overflow: auto">
					<table>
						<thead>
							<tr>
								<th id="tableKeyHeader">group</th>
								<th class="right">completedOrders</th>
								<th class="right">averageLeadTime</th>
								<th class="right">delayedOrderRate</th>
							</tr>
						</thead>
						<tbody id="groupTableBody"></tbody>
					</table>
				</div>
			</div>
		</div>

		<script>
			// --------- tiny helpers ----------
			const $ = (id) => document.getElementById(id);

			function fmtInt(n) {
				if (n === null || n === undefined) return "-";
				const x = Number(n);
				if (!Number.isFinite(x)) return "-";
				return x.toLocaleString("ko-KR");
			}
			function fmtRate(r) {
				if (r === null || r === undefined) return "-";
				const x = Number(r);
				if (!Number.isFinite(x)) return "-";
				return (x * 100).toFixed(0) + "%";
			}

			function setStatus(msg, ok = true) {
				const el = $("statusText");
				el.textContent = msg;
				el.className = ok ? "ok" : "warn";
			}

			// --------- charts (simple canvas bars) ----------
			function drawBarChart(
				canvas,
				items,
				{
					valueKey = "value",
					labelKey = "label",
					valueFormat = "number",
				} = {}
			) {
				const ctx = canvas.getContext("2d");
				const W = (canvas.width =
					canvas.clientWidth * devicePixelRatio);
				const H = (canvas.height =
					canvas.clientHeight * devicePixelRatio);

				// background
				ctx.clearRect(0, 0, W, H);
				ctx.fillStyle = "rgba(0,0,0,0.12)";
				ctx.fillRect(0, 0, W, H);

				const pad = 16 * devicePixelRatio;
				const top = 14 * devicePixelRatio;
				const left = pad,
					right = pad,
					bottom = pad;
				const cw = W - left - right;
				const ch = H - top - bottom;

				// grid
				ctx.strokeStyle = "rgba(255,255,255,0.08)";
				ctx.lineWidth = 1 * devicePixelRatio;
				for (let i = 0; i <= 4; i++) {
					const y = top + (ch * i) / 4;
					ctx.beginPath();
					ctx.moveTo(left, y);
					ctx.lineTo(left + cw, y);
					ctx.stroke();
				}

				const maxVal = Math.max(
					1e-9,
					...items.map((d) => Number(d[valueKey] ?? 0))
				);
				const n = items.length;
				const gap = (cw / Math.max(n, 1)) * 0.18;
				const bw = cw / Math.max(n, 1) - gap;

				ctx.textBaseline = "middle";
				ctx.font = `${11 * devicePixelRatio}px ui-sans-serif,system-ui`;
				ctx.fillStyle = "rgba(231,238,255,0.95)";

				items.forEach((d, i) => {
					const v = Number(d[valueKey] ?? 0);
					const h = (v / maxVal) * (ch * 0.92);
					const x = left + i * (bw + gap);
					const y = top + ch - h;

					// bar
					ctx.fillStyle = "rgba(160, 190, 255, 0.75)";
					ctx.fillRect(x, y, bw, h);

					// label
					const label = String(d[labelKey]);
					ctx.fillStyle = "rgba(147,164,199,0.95)";
					ctx.save();
					ctx.translate(x + bw / 2, top + ch + 10 * devicePixelRatio);
					ctx.rotate(-Math.PI / 10);
					ctx.textAlign = "center";
					ctx.fillText(label, 0, 0);
					ctx.restore();

					// value on top
					ctx.fillStyle = "rgba(231,238,255,0.95)";
					ctx.textAlign = "center";
					const txt = valueFormat === "rate" ? fmtRate(v) : fmtInt(v);
					ctx.fillText(txt, x + bw / 2, y - 10 * devicePixelRatio);
				});
			}

			// --------- render ----------
			function render(kpi, { groupKey = "region", topN = 3 } = {}) {
				// Summary KPI cards
				const kpiCards = [
					{
						label: "Total Orders",
						value: fmtInt(kpi.totalOrders),
						hint: "전체 주문 수",
					},
					{
						label: "Completed Orders",
						value: fmtInt(kpi.completedOrders),
						hint: "완료 주문 수",
					},
					{
						label: "Avg Lead Time",
						value: fmtInt(kpi.averageLeadTime),
						hint: "평균 리드타임(초)",
					},
					{
						label: "Delayed Rate",
						value: fmtRate(kpi.delayedOrderRate),
						hint: "지연 주문 비율",
					},
				];
				$("kpiCards").innerHTML = kpiCards
					.map(
						(c) => `
      <div class="kpi">
        <div class="label">${c.label}</div>
        <div class="value">${c.value}</div>
        <div class="hint">${c.hint}</div>
      </div>
    `
					)
					.join("");

				// Note
				const dq = kpi.dataQuality || {};
				const warn =
					(dq.missingRate ?? 0) > 0.05 ||
					(dq.outOfOrderRate ?? 0) > 0.1;
				$("kpiNote").innerHTML = warn
					? `<span class="warn">주의:</span> 데이터 품질 지표가 높으면 KPI 해석이 흔들릴 수 있어. (누락/역순 확인)`
					: `<span class="ok">양호:</span> 데이터 품질이 큰 문제 없이 KPI를 해석할 수 있어.`;

				// Data Quality cards
				const dqCards = [
					{
						label: "Completion Rate",
						value: fmtRate(dq.completionRate),
						hint: "완료율",
					},
					{
						label: "Missing Rate",
						value: fmtRate(dq.missingRate),
						hint: "이벤트 누락율",
					},
					{
						label: "Dup Type Rate",
						value: fmtRate(dq.duplicateTypesRate),
						hint: "중복 타입율",
					},
					{
						label: "OutOfOrder Rate",
						value: fmtRate(dq.outOfOrderRate),
						hint: "순서 오류율",
					},
				];
				$("dqCards").innerHTML = dqCards
					.map(
						(c) => `
      <div class="kpi">
        <div class="label">${c.label}</div>
        <div class="value">${c.value}</div>
        <div class="hint">${c.hint}</div>
      </div>
    `
					)
					.join("");

				// ByGroup chart/table
				const byGroup = kpi.byGroup || {};
				const entries = Object.entries(byGroup).map(([k, v]) => ({
					key: k,
					completedOrders: v.completedOrders ?? 0,
					averageLeadTime: v.averageLeadTime ?? 0,
					delayedOrderRate: v.delayedOrderRate ?? 0,
				}));

				// sort by averageLeadTime desc, pick topN for chart
				const top = [...entries]
					.sort(
						(a, b) =>
							(b.averageLeadTime || 0) - (a.averageLeadTime || 0)
					)
					.slice(0, topN);

				$(
					"byGroupCaption"
				).textContent = `${groupKey} 기준 상위 ${topN}개 (평균 리드타임 높은 순)`;
				drawBarChart(
					$("chartByGroup"),
					top.map((d) => ({
						label: d.key,
						value: d.averageLeadTime,
					})),
					{
						valueKey: "value",
						labelKey: "label",
						valueFormat: "number",
					}
				);

				// table
				$("tableKeyHeader").textContent = groupKey;
				const tbody = $("groupTableBody");
				const tableRows = [...entries]
					.sort(
						(a, b) =>
							(b.completedOrders || 0) - (a.completedOrders || 0)
					)
					.slice(0, 200);
				tbody.innerHTML = tableRows
					.map(
						(d) => `
      <tr>
        <td>${d.key}</td>
        <td class="right">${fmtInt(d.completedOrders)}</td>
        <td class="right">${fmtInt(d.averageLeadTime)}</td>
        <td class="right">${fmtRate(d.delayedOrderRate)}</td>
      </tr>
    `
					)
					.join("");

				// Bottleneck chart
				const bn = (
					kpi.bottleneckTop ||
					kpi.bottleneckTop3 ||
					[]
				).slice(0, topN);
				$("bottleneckCaption").textContent = `병목 구간 상위 ${Math.min(
					topN,
					bn.length
				)}개`;
				drawBarChart(
					$("chartBottleneck"),
					bn.map((d) => ({ label: d.segment, value: d.ratio })),
					{
						valueKey: "value",
						labelKey: "label",
						valueFormat: "rate",
					}
				);
			}

			// --------- file load ----------
			async function readJsonFile(file) {
				const text = await file.text();
				return JSON.parse(text);
			}

			$("file").addEventListener("change", async (e) => {
				const file = e.target.files?.[0];
				if (!file) return;

				try {
					const kpi = await readJsonFile(file);
					const groupKey = $("groupKey").value;
					const topN = Number($("topN").value);
					render(kpi, { groupKey, topN });
					setStatus(`로드 완료: ${file.name}`, true);
					window.__KPI__ = kpi;
				} catch (err) {
					console.error(err);
					setStatus("로드 실패: JSON 형식 확인 필요", false);
				}
			});

			// controls
			function rerenderIfPossible() {
				if (!window.__KPI__) return;
				const groupKey = $("groupKey").value;
				const topN = Number($("topN").value);
				render(window.__KPI__, { groupKey, topN });
			}
			$("groupKey").addEventListener("change", rerenderIfPossible);
			$("topN").addEventListener("change", rerenderIfPossible);

			// sample
			$("loadSample").addEventListener("click", () => {
				const sample = {
					totalOrders: 300,
					completedOrders: 270,
					averageLeadTime: 2850,
					delayedOrderRate: 0.29,
					bottleneckTop: [
						{ segment: "S3", ratio: 0.42 },
						{ segment: "S5", ratio: 0.33 },
						{ segment: "S6", ratio: 0.15 },
					],
					byGroup: {
						"Seoul-Gangnam": {
							completedOrders: 80,
							averageLeadTime: 3100,
							delayedOrderRate: 0.36,
						},
						"Seoul-Mapo": {
							completedOrders: 60,
							averageLeadTime: 2700,
							delayedOrderRate: 0.25,
						},
						"Seoul-Songpa": {
							completedOrders: 55,
							averageLeadTime: 2950,
							delayedOrderRate: 0.3,
						},
						"Seoul-Yeongdeungpo": {
							completedOrders: 40,
							averageLeadTime: 2600,
							delayedOrderRate: 0.22,
						},
						"Seoul-Seodaemun": {
							completedOrders: 35,
							averageLeadTime: 2500,
							delayedOrderRate: 0.2,
						},
					},
					dataQuality: {
						totalOrders: 300,
						completedOrders: 270,
						completionRate: 0.9,
						missingRate: 0.04,
						duplicateTypesRate: 0.02,
						outOfOrderRate: 0.05,
					},
				};
				window.__KPI__ = sample;
				render(sample, {
					groupKey: $("groupKey").value,
					topN: Number($("topN").value),
				});
				setStatus("샘플 데이터 로드됨", true);
			});

			async function loadBundledKpi() {
				try {
					const res = await fetch("./kpi.json", { cache: "no-store" });
					if (!res.ok) throw new Error(`HTTP ${res.status}`);
					const kpi = await res.json();
					window.__KPI__ = kpi;
					render(kpi, {
						groupKey: $("groupKey").value,
						topN: Number($("topN").value),
					});
					setStatus("배포 데이터(kpi.json) 자동 로드 완료", true);
				} catch (err) {
					console.warn("[dashboard] bundled kpi load failed", err);
					setStatus("JSON 업로드 대기", true);
				}
			}

			// initial
			loadBundledKpi();
		</script>
	</body>
</html>
