# Data Schema

## 1. 목적

본 문서는 배달 주문 이벤트 로그 분석 시스템에서 사용하는 데이터 스키마를 정의한다.  
해당 스키마는 다음을 가능하게 하는 것을 목표로 한다.

-   주문 단위 타임라인 재구성 (`order_id` 기준)
-   배달 리드타임 및 구간별 리드타임 계산
-   지연 주문 비율 및 병목 구간 산출
-   지역/가게/라이더 등 기본 차원 기준 집계

---

## 2. 설계 원칙

1. **이벤트 로그(event_log)가 단일 진실의 원천(Source of Truth)** 이다.
2. 모든 이벤트는 반드시 `order_id`로 묶일 수 있어야 한다.
3. KPI 계산에 필요한 최소 필드만 포함한다.
4. 이벤트 누락/중복/순서 오류가 발생해도 분석 파이프라인이 중단되지 않아야 한다.
5. 파생 가능한 값은 저장하지 않고 분석 단계에서 계산한다.

---

## 3. 데이터 구성 (MVP)

### 3.1 event_log (필수)

이벤트 발생 단위로 1 row가 기록되는 로그 테이블/파일

-   저장 형태: JSONL 또는 CSV (MVP에서는 어떤 형태든 가능)
-   기본 키(권장): `event_id`
-   분석 기본 단위: `order_id`

---

## 4. 이벤트 타입 정의

배달 주문 흐름을 구성하는 최소 이벤트 타입은 다음과 같다.

| event_type       | 설명             |
| ---------------- | ---------------- |
| ORDER_CREATED    | 주문 생성        |
| STORE_ACCEPTED   | 가게 주문 접수   |
| COOKING_STARTED  | 조리 시작        |
| COOKING_FINISHED | 조리 완료        |
| RIDER_ASSIGNED   | 라이더 배차 완료 |
| PICKED_UP        | 라이더 픽업 완료 |
| DELIVERED        | 배달 완료        |

---

## 5. event_log 필드 정의

| Field      | Type            | Required | 설명                                       | 예시                        |
| ---------- | --------------- | -------- | ------------------------------------------ | --------------------------- |
| event_id   | string          | Y        | 이벤트 유일 ID(중복 방지/멱등 처리)        | `evt_000001`                |
| order_id   | string          | Y        | 주문 유일 ID(타임라인 묶음 키)             | `ord_20251215_0007`         |
| event_type | string          | Y        | 이벤트 타입(상태 변화)                     | `ORDER_CREATED`             |
| event_time | string(ISO8601) | Y        | 이벤트 발생 시각(+09:00 포함 권장)         | `2025-12-15T11:03:22+09:00` |
| store_id   | string          | Y        | 가게 ID                                    | `store_102`                 |
| region     | string          | Y        | 지역(구/동 등)                             | `Seoul-Gangnam`             |
| rider_id   | string          | N        | 라이더 ID (배차 이후 이벤트에서 주로 존재) | `rider_33`                  |
| platform   | string          | N        | 플랫폼 구분(MVP에선 고정값 가능)           | `baemin`                    |
| meta       | object          | N        | 확장용 메타데이터(거리/금액 등)            | `{ "distance_km": 2.4 }`    |

---

## 6. 제약 및 규칙

### 6.1 이벤트 중복

-   `event_id`는 유일해야 한다.
-   동일 이벤트가 중복 입력될 수 있으며, 분석 단계에서 `event_id` 기준으로 중복 제거 가능해야 한다.

### 6.2 이벤트 순서

-   일반적으로 `event_time` 오름차순으로 정렬되나,
    실제 로그에서는 순서가 어긋날 수 있다.
-   분석 시 `order_id`로 그룹핑 후 `event_time` 기준 정렬하여 타임라인을 복원한다.

### 6.3 이벤트 누락

-   일부 이벤트가 누락될 수 있다.
-   KPI 계산 시 누락된 구간은 `null` 처리하거나 제외 규칙을 적용한다.
    (예: DELIVERED가 없는 주문은 전체 리드타임 계산 대상에서 제외)

---

## 7. KPI 계산과 스키마의 연결

본 스키마로 다음 KPI를 계산한다.

-   전체 배달 리드타임: `DELIVERED.event_time - ORDER_CREATED.event_time`
-   구간별 리드타임: 이벤트 타입 간 시간 차이
-   지연 주문 비율: `전체 리드타임 > SLA` 조건의 주문 비율
-   병목 구간: 주문별 구간 소요 시간 중 최대 구간

---
